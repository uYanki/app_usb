[TOC]

# 脉冲控制器

### 数字量输入（六通道）

#### 引脚分配

| 通道 | 引脚 |
| ---- | ---- |
| DI0  | PB4  |
| DI1  | PB5  |
| DI2  | PB10 |
| DI3  | PB11 |
| DI4  | PA0  |
| DI5  | PA1  |

### 数字量输出（两通道）

#### 引脚分配

| 通道 | 引脚 |
| ---- | ---- |
| DO0  | PB12 |
| DO1  | PB13 |

### 模拟量输入（四通道）

#### 引脚分配

| 通道 | 引脚 |
| ---- | ---- |
| AI0  | PA2  |
| AI1  | PA3  |
| AI2  | PA4  |
| AI3  | PA5  |

#### 功能说明

AI输入电压数字量 (滤波前) = 采样数据原始值 (Q15) * `AI采样缩放系数` / 1000 + `AI采样偏置`

AI输入电压数字量 (滤波前) + 一阶低通滤波 => `AI输入电压数字量`

`AI输入电压物理值` = `AI输入电压数字量` * `模拟量输入AI采样系数` / 32768

如果 `AI输入电压物理值` 在 `AI输入死区` 范围内，`AI输入电压物理值` 将被设为 0。

#### 外设及实现

ADC 采样序列 +DMA 循环搬运

### 脉冲输出（单通道）

#### 引脚分配

| 通道   | 引脚 |
| ------ | ---- |
| PulOut | PA8  |

#### 功能说明

设定 `高速脉冲输出个数` ，`高速脉冲输出频率` 及 `高速脉冲输出占空比`，然后往 `高速脉冲输出使能` 写 1 以开始发波。往 `高速脉冲输出使能` 写 0 时中断发波。（发波完成后  `高速脉冲输出使能`  会自动被设置为 0）。

* `高速脉冲输出个数`  = 0 时：发出 任意频率，任意个数，任意占空比 的 PWM。

* `高速脉冲输出个数`  > 0 时：发出 任意频率，任意个数，任意占空比 的脉冲。

#### 外设

* `高速脉冲输出个数`  = 0 

TMR 比较输出模式。

* 0 < `高速脉冲输出个数`  < 256

TMR 比较输出模式 + 单周期模式。

* `高速脉冲输出个数`  > 256

TMR 比较输出模式 + 单周期模式 + 定时器溢出中断。

由于 单周期模式 中的 重复周期计数 是8位的寄存器。

当输出脉冲数大于 256 时就需在 定时器溢出中断 中更新剩余需要输出的脉冲数。

#### 难点：任意频率

##### 数学模型

在定时器时间基准固定为144MHz时，控制输出脉冲的周期、频率取决于PSC（预分频）和ARR（重装载），有等式：PSC * ARR * F = 144 000 000，当在输入F确定时，可得等式：PSC * ARR = 144 000 000 / F，即PSC * ARR = 确定值。但是PSC和ARR在32单片机当中都是16位的寄存器，所以也就有了限制条件：0 < PSC < 65535 、 0 < ARR < 65535 。

已知 0<psc<65535，0<arr<65535，0< f <144 * 1000 * 1000，在 psc 、 arr 和 f 均为整数，且 f 已定的前提下，求 psc 和 arr 的数值使得 psc * arr * f = 144 * 1000 * 1000 的误差最小。

##### 解决方法分析

在确定F的情况下，PSC * ARR = 144 000 000 / F 等同于 PSC * ARR = T，T = 144 000 000 / F。由于PSC和ARR的限制条件（小于65536的自然数），导致PSC * ARR不一定等于T（比如T为大于65535的质数）。所以要尽量减少由PSC和ARR得到的频率与所需求频率的误差。

首先判断PSC * ARR = T等式能否直接成立，通过T对范围内所有不同的PSC相除，判断是否余数为0，如果为0，说明存在两个整数相乘可以得到T，其中除于PSC后得到的值为ARR，但是同时需要注意ARR也有限制条件，只有满足：T能被在范围内的PSC整除，且整除结果ARR也在范围内，才能得到误差为0的PSC * ARR组合。（使用遍历的方法得到满足 PSC * ARR = T 公式的PSC和ARR）

如果T没有符合条件的PSC * ARR组合，那可以先试试T+1（误差为1/(T+1)）是否具有满足 PSC * ARR = T+1 公式的PSC和ARR，如果依然没有的话，再尝试一下T-1（误差为1/(T-1)）,仍然没有的话，继续尝试T+2（误差为2/(T+2)）、T-2（误差为2/(T-2)）、T+3（误差为3/(T+3)）…等方案，同时，还需要考虑到T+x确保在0 ~ 65535*65535的范围内（不在此范围内的T是永远得不到满足条件的PSC * ARR组合）。最终在满足这些条件下得出对应的PSC * ARR组合，而由此组合得到的单片机脉冲频率与所需频率误差最小（事实上由频率转成T往往存在小数，本方案忽略小数部分的误差）

### 脉冲输入（单通道）

| 通道   | 引脚 |
| ------ | ---- |
| PulIn1 | PA6  |
| PulIn2 | PA7  |

#### 功能说明

设定 `高速脉冲输入模式` ，然后往 `高速脉冲输入使能` 写 1 以开始捕获脉冲。往 `高速脉冲输入使能` 写 0 时中断捕获，且将 `高速脉冲输入计数` 清 0。捕获到的边沿数存放至 `高速脉冲输入计数`。

同时 `高速脉冲输入计数` 作为 编码器的多圈位置 值，会根据 `编码器分辨率` 解析出 `编码器单圈位置` 和 `编码器圈数`。

#### 外设

TMR 的 正交编码器模式。

### 可编程方波

#### 引脚分配

| 通道        | 引脚 |
| ----------- | ---- |
| FlexPulOut0 | PB0  |
| FlexPulOut1 | PB1  |
| FlexPulOut2 | PB2  |
| FlexPulOut3 | PB3  |

#### 功能说明

设定  `可编程脉冲输出更新频率`、`可编程脉冲数据点起始索引`、`可编程脉冲数据点结束索引` 及 `可编程脉冲数据点`，然后往 `可编程脉冲输出使能` 写 1 以开始输出脉冲。

可通过设定 `可编程脉冲数据点` 来实现相移，或 AB正交脉冲/PD脉冲/CW-CCW脉冲的输出。

#### 外设

DMA + GPIO + TMR 溢出信号。

定时器的溢出信号 周期性触发 DMA，DMA 会将内存数据 循环搬运到 GPIO 的输出状态寄存器。

